# 登录功能说明

## 概述

本任务管理系统的登录功能已与Supabase数据库严格绑定，只有数据库中存在的用户才能成功登录。系统会验证用户名和密码，确保数据安全。

## 功能特点

### 🔐 数据库验证
- **严格验证**：登录信息必须与数据库中的用户数据完全匹配
- **实时查询**：每次登录都会实时查询数据库验证用户身份
- **角色识别**：自动识别用户角色（管理员/普通用户）
- **安全防护**：防止未授权访问，确保系统安全

### 🎯 用户体验
- **加载状态**：登录过程中显示"登录中..."状态
- **错误提示**：清晰的错误信息提示（用户名或密码错误）
- **输入验证**：确保用户名和密码都已填写
- **界面禁用**：登录过程中禁用表单输入，防止重复提交

## 数据库设置

### 1. 创建用户表

首先确保在Supabase中创建了用户表，表结构如下：

```sql
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,  -- 注意：生产环境应使用加密密码
    role VARCHAR(20) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. 插入测试用户

**方法一：使用测试脚本（推荐）**

在Supabase控制台的SQL编辑器中运行 `test-users.sql` 文件：

```sql
-- 插入测试用户（明文密码，仅用于开发测试）
INSERT INTO users (username, email, password, role) VALUES 
('admin', 'admin@example.com', 'admin123', 'admin'),
('user1', 'user1@example.com', 'user123', 'user'),
('user2', 'user2@example.com', 'user123', 'user');
```

**方法二：手动添加**

在Supabase控制台的表编辑器中手动添加用户记录。

## 测试账号

系统提供以下测试账号：

| 角色 | 用户名 | 密码 | 权限 |
|------|--------|------|------|
| 管理员 | admin | admin123 | 完整系统管理权限 |
| 普通用户 | user1 | user123 | 基础任务管理权限 |
| 普通用户 | user2 | user123 | 基础任务管理权限 |

## 使用步骤

### 1. 启动应用
```bash
npm start
```

### 2. 访问登录页面
打开浏览器访问 `http://localhost:3000`

### 3. 输入登录信息
- 在用户名框中输入：`admin` 或 `user1`
- 在密码框中输入对应密码
- 点击"登录"按钮

### 4. 验证结果
- **成功**：进入系统主界面，显示用户信息和角色
- **失败**：显示错误信息，请检查用户名和密码

## 错误处理

### 常见错误及解决方案

1. **"用户名或密码错误"**
   - 检查输入的用户名和密码是否正确
   - 确认数据库中存在该用户
   - 验证密码是否匹配

2. **"登录失败，请稍后重试"**
   - 检查网络连接
   - 确认Supabase配置正确
   - 查看浏览器控制台错误信息

3. **"请输入用户名和密码"**
   - 确保两个输入框都已填写
   - 不能有空格或特殊字符

### 调试步骤

1. **检查数据库连接**
   - 使用系统中的"数据库测试"功能
   - 确认Supabase配置正确

2. **验证用户数据**
   - 在Supabase控制台查看users表
   - 确认用户记录存在且密码正确

3. **查看控制台日志**
   - 打开浏览器开发者工具
   - 查看Console标签页的错误信息

## 安全注意事项

### ⚠️ 开发环境
- 当前使用明文密码存储，仅适用于开发测试
- `test-users.sql` 文件包含明文密码，请勿用于生产环境

### 🔒 生产环境建议
- 使用bcrypt等库对密码进行哈希加密
- 实现密码强度验证
- 添加登录失败次数限制
- 使用HTTPS协议
- 定期更新密码

## 技术实现

### 核心函数

**`authenticateUser(username, password)`**
- 位置：`src/services/databaseService.js`
- 功能：验证用户登录信息
- 返回：包含用户信息或错误信息的对象

**`handleLogin(e)`**
- 位置：`src/App.js`
- 功能：处理登录表单提交
- 特点：异步处理，包含加载状态和错误处理

### 状态管理

- `loginLoading`：登录加载状态
- `loginError`：登录错误信息
- `currentUser`：当前登录用户信息
- `isLoggedIn`：登录状态标识

## 扩展功能

### 可添加的功能
1. **记住登录状态**：使用localStorage保存登录信息
2. **自动登出**：设置会话超时自动登出
3. **密码重置**：添加忘记密码功能
4. **用户注册**：允许新用户自主注册
5. **双因素认证**：增强安全性

### 性能优化
1. **登录缓存**：缓存用户信息减少数据库查询
2. **连接池**：优化数据库连接管理
3. **错误重试**：网络错误时自动重试

---

**最后更新**：2024年1月
**版本**：1.0.0
**维护者**：任务管理系统开发团队